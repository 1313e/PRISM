language: python
dist: xenial
sudo: true
matrix:
  include:
    - python: 2.7
      env: RUN_COVERAGE=0
    - python: 3.5
      env: RUN_COVERAGE=1
    - python: 3.5-dev
      env: RUN_COVERAGE=0
    - python: 3.6
      env: RUN_COVERAGE=0
    - python: 3.6-dev
      env: RUN_COVERAGE=0
    - python: 3.7
      env: RUN_COVERAGE=0
    - python: 3.7-dev
      env: RUN_COVERAGE=0
install:
  - pip install -r requirements_dev.txt
script:
  - check-manifest
  - python setup.py sdist bdist_wheel
  - twine check dist/*
  - pip install -e .
  - python -c "import prism; prism.get_info()"
  - |
    if [[ "$RUN_COVERAGE" == "1" ]]; then
      coverage run --rcfile=setup.cfg -m pytest
    else
      pytest
    fi
  - sudo apt-get install -y -q openmpi-bin libopenmpi-dev
  - pip --no-cache install mpi4py
  - |
    if [[ "$RUN_COVERAGE" == "1" ]]; then
      mpiexec -n 2 coverage run --rcfile=setup.cfg -m mpi4py -m pytest
      coverage combine
      coverage report -m
    else
      mpiexec -n 2 pytest
    fi
after_success:
  - |
    if [[ "$RUN_COVERAGE" == "1" ]]; then
      codecov
    fi
before_deploy:
    - rm -r dist
    - rm -r build
deploy:
    provider: pypi
    user: "1313e"
    password:
        secure: "FDNYxLxDbfzRawTpvib11G44RRGr/T7WAPcPKbzjzQodJXrHTpkW/+gttuDh7eyCCEGW/4zZ00fMnGmlVciXA7xXOYG1F7n6F9OiH+jLCBFrujdU4X4z7VlBqo1OdOHbF9Aw4HnnrWg4fhnnC46Hqd36g6O5ugUjBPmLbpvrEyZ/uSdb31CCx9x30Ugdl6dPiMyNm9kCQTv15widVGM/GZHK8Dru8qILygxHt60WW0MEG+JyUyKxhpgz3yY/a/Yea9YU2kPwrUamOumoT+p3/WOOLjY7ZuX3CvdbWkYOoVVhGgueEzzXYedleiFKbGF3WFSSTzFkEfcohivhvqicYX9Z/mV4+26Uzp23DGL2rhm7T2ctnKTFmlyp6KgDKBSIcb0D3mH/WfMdOZRKgsP/SHD1TKrwvSkC3EZWIKTCtPOQHs06cbY/bAj7R1hI7Pr78jPCa125lRj3wHH96ONXLDAcKKU3kcDYjL9EtDMGQDyDUg1fORBxVmXrqm8GKrBoBCiwFJ70nw8vaAsT3Pa/QO2x9Ng5nhrujjiIJ8U6h35aepgoSxk3fDEqXxRcp/B4gaWXas+tbZk9AkcGQEOkfZyVpW8BrsEhyUN9K2yEPQFD009fRmBOYJBLcYAvKgcvDhj9IsPSP+P+CBe5yV7tf+YCBroILgs6d5O/r9yAtYI="
    distributions: "sdist bdist_wheel"
    skip_existing: true
    on:
        branch: master
    
notifications:
  email: false
